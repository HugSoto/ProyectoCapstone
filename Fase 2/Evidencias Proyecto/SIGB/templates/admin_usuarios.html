<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n de Usuarios - SIGB</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #800080; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
        th { background-color: #800080; color: white; }
        button { background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .success { color: green; font-weight: bold; }
        .inactivo { background-color: #f8d7da; color: #721c24; }
        /* Estilos de formulario y modales (simplificados) */
        .form-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .form-section label { display: block; margin-top: 10px; font-weight: bold; }
        .form-section input, .form-section select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Gesti√≥n de Usuarios (CRUD) üßë‚Äçüíª</h1>
    <p>Solo visible para el rol 'Admin'. Permite crear, editar y desactivar cuentas de personal.</p>

    <h2>1. Registrar Nuevo Usuario</h2>
    <div class="form-section">
        <form id="registrarUsuarioForm">
            <input type="hidden" id="editId" value="">
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="nombre">Nombre Completo:</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                <div style="flex: 1;">
                    <label for="rut">RUT:</label>
                    <input type="text" id="rut" name="rut" required>
                </div>
            </div>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="correo">Correo:</label>
                    <input type="email" id="correo" name="correo" required>
                </div>
                <div style="flex: 1;">
                    <label for="telefono">Tel√©fono:</label>
                    <input type="text" id="telefono" name="telefono" required>
                </div>
                <div style="flex: 1;">
                    <label for="rol">Rol:</label>
                    <select id="rol" name="rol" required>
                        <option value="Estudiante">Estudiante</option>
                        <option value="Bibliotecario">Bibliotecario</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <button type="submit" id="submitBtn" style="background-color: #28a745;">Registrar</button>
            <button type="button" onclick="resetForm()" style="background-color: #ffc107;">Cancelar Edici√≥n</button>
        </form>
    </div>

    <h2>2. Inventario de Cuentas del Sistema</h2>
    <p id="loadingList">Cargando usuarios...</p>
    
    <table id="usuariosTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>RUT</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="usuariosBody">
            </tbody>
    </table>
</div>

<script>
    const API_LISTAR = '/api/admin/usuarios';
    const API_REGISTRAR = '/api/usuario/registrar'; // T06
    const API_EDITAR = '/api/admin/usuario/editar'; 
    const API_BLOQUEAR = '/api/admin/usuario/bloquear';
    const API_OBTEN_USUARIO = '/api/admin/usuario/obtener';
    const API_REACTIVAR = '/api/admin/usuario/reactivar';
    // ------------------------------------------------------------------
    // NUEVA FUNCI√ìN: OBTENER UN √öNICO USUARIO POR ID (READ Espec√≠fico)
    // ------------------------------------------------------------------
    async function obtenerUsuarioPorId(id) {
        try {
            // üö® FALTA LA RUTA DE BACKEND: Asumimos la ruta /api/admin/usuario/obtener/<id>
            const response = await fetch(`${API_OBTEN_USUARIO}/${id}`); 
            if (!response.ok) throw new Error("Fallo al obtener datos.");
            return await response.json();
        } catch (error) {
            console.error("Error al obtener usuario:", error);
            return null;
        }
    }

    // Funci√≥n para listar usuarios (READ)
    async function listarUsuarios() {
        const usuariosBody = document.getElementById('usuariosBody');
        usuariosBody.innerHTML = '';
        document.getElementById('loadingList').style.display = 'block';

        try {
            const response = await fetch(API_LISTAR);
            // El API ya tiene el decorador @admin_required. Si falla aqu√≠, es por seguridad (401/403).
            if (!response.ok) {
                if (response.status === 403) {
                    usuariosBody.innerHTML = '<tr><td colspan="7">üö´ Acceso Denegado. Solo los Administradores pueden ver esta tabla.</td></tr>';
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                document.getElementById('loadingList').style.display = 'none';
                return;
            }
            
            const usuarios = await response.json();
            document.getElementById('loadingList').style.display = 'none';

            usuarios.forEach(user => {
                const row = usuariosBody.insertRow();
                const estado = user.estado_activo ? 'Activo' : 'Inactivo';
                
                if (!user.estado_activo) {
                    row.classList.add('inactivo');
                }

                row.insertCell(0).textContent = user.id_usuario;
                row.insertCell(1).textContent = user.nombre;
                row.insertCell(2).textContent = user.rut;
                row.insertCell(3).textContent = user.correo;
                row.insertCell(4).textContent = user.rol;
                row.insertCell(5).textContent = estado;

                const actionsCell = row.insertCell(6);
                actionsCell.innerHTML = `
                    <button onclick="iniciarEdicion(${user.id_usuario})" style="background-color: #007bff;">Editar</button>
                    ${user.estado_activo 
                        ? `<button onclick="bloquearUsuario(${user.id_usuario})" style="background-color: #dc3545;">Bloquear</button>` 
                        : `<button onclick="reactivarUsuario(${user.id_usuario})" style="background-color: #28a745;">Activar</button>` 
                    }
                `;
            });

        } catch (error) {
            console.error("Error al listar usuarios:", error);
            document.getElementById('loadingList').textContent = 'Error: No se pudo cargar el listado de usuarios.';
        }
    }
    
    // ------------------------------------------------------------------
    // FUNCI√ìN PARA INICIAR LA EDICI√ìN (HU-ADMIN02)
    // ------------------------------------------------------------------
    async function iniciarEdicion(id) {
        const user = await obtenerUsuarioPorId(id);
        if (!user) {
            alert("Error: Usuario no encontrado o fallo en la conexi√≥n.");
            return;
        }
        
        // Llenar el formulario con los datos obtenidos
        document.getElementById('nombre').value = user.nombre;
        document.getElementById('rut').value = user.rut; // RUT no se suele editar
        document.getElementById('correo').value = user.correo;
        document.getElementById('telefono').value = user.telefono;
        document.getElementById('rol').value = user.rol; // Cargar rol actual
        
        // Configurar el formulario para la operaci√≥n de UPDATE
        document.getElementById('editId').value = id;
        document.getElementById('submitBtn').textContent = 'Guardar Cambios';
        
        alert(`Modo Edici√≥n iniciado para: ${user.nombre}`);
    }

    // Funci√≥n para bloquear la cuenta (DELETE L√≥gico - HU-ADMIN02)
    // Funci√≥n para bloquear la cuenta (DELETE L√≥gico - HU-ADMIN02)
    async function bloquearUsuario(id) {
    if (!confirm("¬øEst√° seguro de que desea bloquear/desactivar esta cuenta?")) return;
    
    try {
        const response = await fetch(`${API_BLOQUEAR}/${id}`, {
            method: 'PUT',
            // üö® SOLUCI√ìN FINAL: Usamos un cuerpo vac√≠o para evitar que Flask falle.
            body: JSON.stringify({}) // Enviamos un objeto JSON vac√≠o
        });

        if (response.ok) {
            alert("Cuenta bloqueada con √©xito.");
            listarUsuarios(); 
        } else {
            const result = await response.json().catch(() => ({error: "Error del servidor (No JSON)."}));
            alert(result.error || "Fallo al bloquear la cuenta.");
        }
    } catch (error) {
        console.error("Error de conexi√≥n al bloquear:", error);
    }
}

    async function reactivarUsuario(id) {
    if (!confirm("¬øConfirma que desea reactivar la cuenta?")) return;
    
    try {
        const response = await fetch(`${API_REACTIVAR}/${id}`, { method: 'PUT' });

        if (response.ok) {
            alert("Cuenta reactivada con √©xito.");
            listarUsuarios(); 
        } else {
            const result = await response.json().catch(() => ({error: "Fallo de servidor."}));
            alert(result.error || "Fallo al reactivar la cuenta.");
        }
    } catch (error) {
        console.error("Error de conexi√≥n al reactivar:", error);
    }
}
    // Funci√≥n para manejar el env√≠o del formulario (CREATE/UPDATE)
    document.getElementById('registrarUsuarioForm').addEventListener('submit', async function(event) {
        event.preventDefault(); 
        const id = document.getElementById('editId').value;
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        let url = id ? `${API_EDITAR}/${id}` : API_REGISTRAR;
        let method = id ? 'PUT' : 'POST';

        // NOTE: La interfaz actual no tiene campo de contrase√±a. 
        // Para UPDATE (PUT), la contrase√±a no se env√≠a. Para CREATE (POST), la API registrar_usuario no la requiere.

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message || 'Operaci√≥n exitosa.');
                resetForm();
                listarUsuarios();
            } else {
                alert(result.error || 'Error desconocido en la operaci√≥n.');
            }
        } catch (error) {
            console.error("Error en el env√≠o del formulario:", error);
        }
    });

    function resetForm() {
        document.getElementById('registrarUsuarioForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('submitBtn').textContent = 'Registrar';
    }

    window.onload = listarUsuarios;
</script>

</body>
</html>